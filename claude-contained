#!/usr/bin/env bash
set -euo pipefail

show_help() {
  cat <<'EOF'
Usage:
  claude-contained [main_dir] [extra_dir ...] [-- <claude args...>]

Description:
  Runs Claude Code inside an Apple Containers sandbox.

Behavior:
  - If no directories are provided, defaults to the current directory.
  - The first directory is mounted as /work/main and used as the working directory.
  - Additional directories are mounted as /work/extraN and automatically
    added to Claude using --add-dir.
  - Claude state is persisted in the named volume: claude_state
  - SSH agent is forwarded (--ssh).

Examples:
  claude-contained
  claude-contained .
  claude-contained . ../other/project ../shared/lib
  claude-contained . ../other/project -- --model sonnet --verbose
  claude-contained -- --help
EOF
}

if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
  show_help
  exit 0
fi

if [[ $# -eq 0 ]]; then
  set -- "."
fi

# Split directories (before --) vs Claude args (after --)
paths=()
claude_args=()
seen_sep=0
for a in "$@"; do
  if [[ "$a" == "--" ]]; then
    seen_sep=1
    continue
  fi
  if [[ $seen_sep -eq 0 ]]; then
    paths+=("$a")
  else
    claude_args+=("$a")
  fi
done

# If user did: claude-contained -- <claude args...>
if [[ ${#paths[@]} -eq 0 ]]; then
  paths+=(".")
fi

realpath_py() {
  python3 - "$1" <<'PY'
import os,sys
print(os.path.realpath(sys.argv[1]))
PY
}

main_host="$(realpath_py "${paths[0]}")"
main_guest="/work/main"

# Ensure state volume exists
container volume create claude_state >/dev/null 2>&1 || true

# Ensure the volume is writable by user 'dev' inside the container.
# We do this as root, once per machine/volume. It's safe to run every time.
container run --rm -u 0 \
  -v claude_state:/home/dev \
  claude-contained:latest \
  sh -lc 'chown -R dev:dev /home/dev || true' \
  >/dev/null 2>&1 || true

run_argv=(
  container run --rm -it
  --name claude-contained
  --ssh
  -v claude_state:/home/dev
  -w "${main_guest}"
  --mount "type=bind,src=${main_host},dst=${main_guest}"
  claude-contained:latest
  claude
)

# Additional mounts + auto --add-dir
idx=1
for p in "${paths[@]:1}"; do
  hp="$(realpath_py "$p")"
  gp="/work/extra${idx}"
  run_argv+=( --mount "type=bind,src=${hp},dst=${gp}" )
  run_argv+=( --add-dir "${gp}" )
  idx=$((idx+1))
done

if [[ ${#claude_args[@]} -gt 0 ]]; then
  run_argv+=( "${claude_args[@]}" )
fi

exec "${run_argv[@]}"
