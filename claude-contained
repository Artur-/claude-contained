#!/usr/bin/env bash
set -euo pipefail

show_help() {
  cat <<'EOF'
Usage:
  claude-contained [main_dir] [extra_dir ...] [-- <claude args...>]

Description:
  Runs Claude Code inside an Apple Containers sandbox.

Behavior:
  - If no directories are provided, defaults to the current directory.
  - The first directory is mounted as /work/main and used as the working directory.
  - Additional directories are mounted as /work/extraN and automatically
    added to Claude using --add-dir.
  - Claude state is persisted in the named volume: claude_state
  - SSH agent is forwarded (--ssh).

Examples:
  claude-contained
  claude-contained .
  claude-contained . ../other/project ../shared/lib
  claude-contained . ../other/project -- --model sonnet --verbose
  claude-contained -- --help
EOF
}

if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
  show_help
  exit 0
fi

if [[ $# -eq 0 ]]; then
  set -- "."
fi

# Split directories (before --) vs Claude args (after --)
paths=()
claude_args=()
seen_sep=0
for a in "$@"; do
  if [[ "$a" == "--" ]]; then
    seen_sep=1
    continue
  fi
  if [[ $seen_sep -eq 0 ]]; then
    paths+=("$a")
  else
    claude_args+=("$a")
  fi
done

# If user did: claude-contained -- <claude args...>
if [[ ${#paths[@]} -eq 0 ]]; then
  paths+=(".")
fi

resolve_path() {
  if command -v python3 &>/dev/null; then
    python3 -c 'import os,sys; print(os.path.realpath(sys.argv[1]))' "$1"
  elif command -v realpath &>/dev/null; then
    realpath "$1"
  elif command -v readlink &>/dev/null && readlink -f / &>/dev/null; then
    readlink -f "$1"
  else
    # Fallback: works for directories
    (cd "$1" 2>/dev/null && pwd) || echo "$1"
  fi
}

main_host="$(resolve_path "${paths[0]}")"
main_guest="/work/main"

# Ensure state volume exists
container volume create claude_state >/dev/null 2>&1 || true

# Ensure the volume is writable by user 'dev' inside the container.
# Only run once per volume by checking for a marker file.
# STAY_ROOT=1 tells the entrypoint to not drop privileges.
marker_check=$(container run --rm -e STAY_ROOT=1 \
  -v claude_state:/home/dev \
  claude-contained:latest \
  sh -c 'test -f /home/dev/.ownership_fixed && echo yes || echo no' 2>/dev/null) || marker_check="no"

if [[ "$marker_check" != "yes" ]]; then
  container run --rm -e STAY_ROOT=1 \
    -v claude_state:/home/dev \
    claude-contained:latest \
    sh -c 'chown -R dev:dev /home/dev && touch /home/dev/.ownership_fixed' \
    >/dev/null 2>&1 || true
fi

# Build container args separately from claude args
container_argv=(
  container run --rm -it
  --name "claude-contained-$$"
  --ssh
  -v claude_state:/home/dev
  -w "${main_guest}"
  --mount "type=bind,src=${main_host},dst=${main_guest}"
)

claude_argv=(claude)

# Additional mounts go to container_argv, --add-dir goes to claude_argv
idx=1
for p in "${paths[@]:1}"; do
  hp="$(resolve_path "$p")"
  gp="/work/extra${idx}"
  container_argv+=( --mount "type=bind,src=${hp},dst=${gp}" )
  claude_argv+=( --add-dir "${gp}" )
  idx=$((idx+1))
done

# Append user's claude args
if [[ ${#claude_args[@]} -gt 0 ]]; then
  claude_argv+=( "${claude_args[@]}" )
fi

exec "${container_argv[@]}" claude-contained:latest "${claude_argv[@]}"
